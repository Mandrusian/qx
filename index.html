<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qi Xing - QX-Forums</title>
    <style>
        /* Basic styling, you will need to replace/extend this to match macserialjunkie.com */
        body {
            font-family: sans-serif; /* Use fonts from macserialjunkie.com */
            margin: 0;
            background-color: #f0f0f0; /* Match background */
            color: #333; /* Match text color */
            display: flex;
            justify-content: center;
             align-items: center;
             min-height: 100vh; /* Center content vertically */
        }

        .app-container {
            width: 100%;
             max-width: 960px; /* Adjust based on macserialjunkie.com's container width */
             margin: 20px auto; /* Center the container */
            background-color: #fff;
            border-radius: 8px;
             box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: flex;
             flex-direction: column; /* Stack contents vertically */
             min-height: 80vh; /* Ensure minimum height */
             position: relative; /* Needed for absolute positioning of menu */
        }

        /* --- Responsive Adjustments --- */
        @media (max-width: 600px) {
            body {
                padding-top: 0; /* Remove top padding on smaller screens */
                 align-items: flex-start; /* Align items to the top on smaller screens */
            }
            .app-container {
                max-width: 100%; /* Use full width on smaller screens */
                min-height: 100vh; /* Use full viewport height on smaller screens */
                border-radius: 0; /* Remove border radius on full screen */
                box-shadow: none; /* Remove box shadow */
                 margin: 0; /* Remove margin */
            }
        }


        /* --- Header Styles (used for all views) --- */
        .header {
            background-color: #a0c4ff; /* Match header background */
            color: #333; /* Match header text color */
            padding: 15px 20px; /* Adjusted padding */
            text-align: center;
            flex-shrink: 0; /* Prevent header from shrinking */
             display: flex; /* Use flexbox for header content */
             justify-content: space-between; /* Space out items */
             align-items: center; /* Vertically align items */
        }

         .header .title {
             flex-grow: 1; /* Allow title to take space */
             text-align: center;
             margin-left: 30px; /* Offset for back button */
         }


        .header h1 {
            margin: 0;
            font-size: 1.8em; /* Adjust font size */
        }

        .header p {
            margin: 2px 0 0;
            font-size: 0.9em; /* Adjust font size */
        }

         .header .account-icon {
             font-size: 1.5em;
             cursor: pointer;
         }

          .header .back-button {
               font-size: 1.5em;
               cursor: pointer;
                margin-right: 10px;
                display: none; /* Hidden by default */
           }


        /* --- View Specific Styles --- */
        .view {
            flex-grow: 1; /* Allow views to take available space */
            padding: 20px;
            overflow-y: auto; /* Add scrolling if content overflows */
             display: none; /* Hidden by default */
             flex-direction: column; /* Use flexbox for content within the view */
        }

        .view.active {
             display: flex; /* Show the active view */
        }

        /* --- Login/Signup Form Styles --- */
        .auth-form {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            max-width: 300px; /* Limit form width */
            margin: 20px auto; /* Center the form */
             display: flex;
             flex-direction: column;
        }

        .auth-form h2 {
            text-align: center;
            margin-top: 0;
            margin-bottom: 20px;
        }

        .auth-form label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .auth-form input[type="text"],
        .auth-form input[type="password"] {
            width: calc(100% - 22px); /* Adjust width for padding and border */
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .auth-form button {
            width: 100%;
            padding: 10px;
            background-color: #a0c4ff;
            border: none;
            border-radius: 20px;
            color: #333;
            font-size: 1em;
            cursor: pointer;
            margin-bottom: 10px;
        }

         .auth-form button:hover {
             background-color: #8cb3f0;
         }

        .auth-form .switch-link {
            text-align: center;
            font-size: 0.9em;
        }

        .auth-form .switch-link a {
            color: #007bff; /* Standard link color */
            text-decoration: none;
            cursor: pointer;
        }


        /* --- Forum Thread List Styles --- */
         .thread-list-view .forum-section {
             margin-bottom: 0; /* No margin for the last section */
         }

        .thread-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .thread-item {
            display: flex; /* Use flexbox for layout */
            justify-content: space-between; /* Space out items */
            align-items: center; /* Vertically align items */
            padding: 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }

        .thread-item:last-child {
            border-bottom: none;
        }

        .thread-item:hover {
            background-color: #f5f5f5;
        }

         .thread-item .thread-info {
              flex-grow: 1; /* Allow info to take space */
         }

        .thread-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .thread-meta {
            font-size: 0.9em;
            color: #666;
        }

         .thread-item .thread-reply-count {
              font-size: 0.9em;
              color: #999;
              margin-left: 10px;
         }

         /* --- Create Thread Form Styles --- */
         .create-thread-form {
              background-color: #fff;
              border-radius: 8px;
              box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
              padding: 15px;
              margin-top: 20px;
         }

         .create-thread-form h3 {
              margin-top: 0;
              margin-bottom: 10px;
         }

         .create-thread-form input[type="text"] {
              width: calc(100% - 20px);
              padding: 10px;
              border: 1px solid #ccc;
              border-radius: 4px;
              margin-bottom: 10px;
              font-family: sans-serif;
         }

         .create-thread-form button {
              padding: 10px 20px;
              background-color: #a0c4ff;
              border: none;
              border-radius: 20px;
              color: #333;
              font-size: 1em;
              cursor: pointer;
         }

          .create-thread-form button:hover {
               background-color: #8cb3f0;
          }


         /* --- Thread Posts View Styles --- */
         .thread-posts-view .posts-list-area {
              flex-grow: 1; /* Allow posts area to grow */
              overflow-y: auto; /* Add scrolling */
         }

        .post-item {
            background-color: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 15px;
             position: relative; /* For positioning delete button */
        }

        .post-item .post-header {
             display: flex;
             justify-content: space-between;
             align-items: center;
             margin-bottom: 5px;
        }

        .post-item .post-author {
             font-weight: bold;
        }

         .post-item .post-delete-button {
              font-size: 0.8em;
              color: #dc3545; /* Red color */
              cursor: pointer;
              margin-left: 10px;
         }

         .post-item .post-delete-button:hover {
              text-decoration: underline;
         }


        .post-content {
             margin-bottom: 10px;
             word-wrap: break-word; /* Prevent long words from overflowing */
        }

         .post-files a {
             display: inline-block;
             margin-right: 10px;
             font-size: 0.9em;
             color: #007bff;
             text-decoration: none;
         }

          .post-files a:hover {
               text-decoration: underline;
          }

         .post-meta {
              font-size: 0.8em;
              color: #999;
         }


        /* Styles for the posting area (used for replies) */
        .posting-area {
             background-color: #fff;
             border-radius: 8px;
             box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
             padding: 15px;
             margin-top: 20px;
             flex-shrink: 0; /* Prevent posting area from shrinking */
        }

        .posting-area h3 {
             margin-top: 0;
             margin-bottom: 10px;
        }

        .posting-area textarea {
             width: calc(100% - 20px);
             padding: 10px;
             border: 1px solid #ccc;
             border-radius: 4px;
             margin-bottom: 10px;
             resize: vertical;
             font-family: sans-serif;
             min-height: 80px; /* Give textarea a minimum height */
        }

         .posting-actions {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
         }

        .file-upload {
             display: flex;
             align-items: center;
             margin-bottom: 10px; /* Add space below on smaller screens */
         }

         .file-upload input[type="file"] {
              margin-right: 10px;
         }


         .post-button {
             padding: 10px 20px;
             background-color: #a0c4ff;
             border: none;
             border-radius: 20px;
             color: #333;
             font-size: 1em;
             cursor: pointer;
         }

         .post-button:hover {
             background-color: #8cb3f0;
         }

         /* --- Account Menu Styles --- */
         .account-menu {
              position: absolute;
              top: 60px; /* Adjusted based on header height */
              right: 10px; /* Adjusted positioning */
              background-color: #fff;
              border: 1px solid #ccc;
              border-radius: 4px;
              box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
              padding: 10px;
              z-index: 1000; /* Ensure it appears above other content */
              display: none; /* Hidden by default */
              min-width: 150px; /* Ensure readability */
         }

         .account-menu.active {
              display: block; /* Show when active */
         }

         .account-menu ul {
              list-style: none;
              padding: 0;
              margin: 0;
         }

         .account-menu ul li {
              padding: 8px 12px;
              cursor: pointer;
         }

         .account-menu ul li:hover {
              background-color: #f0f0f0;
         }

          .account-menu ul li a {
               text-decoration: none;
               color: #333;
               display: block; /* Make the whole list item clickable */
          }


        /* Add more CSS here to match macserialjunkie.com's specific styles,
           including navigation, sidebars (if any), specific fonts, colors, spacing, etc.
        */

    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
             <span class="back-button" id="backButton">&lt; Threads</span> <!-- Back button -->
             <div class="title">
                 <h1>Qi Xing</h1>
                 <p>QX-Forums</p>
             </div>
            <!-- Add navigation elements here to match macserialjunkie.com -->
             <div class="account-icon" id="accountIcon">👤</div> <!-- Placeholder icon for account menu -->
        </div>

        <!-- Account Menu Structure -->
        <div id="accountMenu" class="account-menu">
             <ul>
                 <li><a href="#" id="manageAccountLink">Manage Account</a></li>
                 <li><a href="#" id="signOutLink">Sign Out</a></li>
             </ul>
        </div>


        <!-- Login View -->
        <div id="loginView" class="view active">
             <div class="auth-form">
                 <h2>Sign In</h2>
                 <label for="loginUsername">Username:</label>
                 <input type="text" id="loginUsername">

                 <label for="loginPassword">Password:</label>
                 <input type="password" id="loginPassword">

                 <button id="signInButton">Sign In</button>
                 <div class="switch-link">
                     Don't have an account? <a href="#" id="showSignUp">Sign Up</a>
                 </div>
             </div>
        </div>

         <!-- Signup View -->
        <div id="signupView" class="view">
             <div class="auth-form">
                 <h2>Sign Up</h2>
                 <label for="signupUsername">Username:</label>
                 <input type="text" id="signupUsername">

                 <label for="signupPassword">Password:</label>
                 <input type="password" id="signupPassword">

                 <button id="signUpButton">Sign Up</button>
                 <div class="switch-link">
                     Already have an account? <a href="#" id="showSignIn">Sign In</a>
                 </div>
            </div>
        </div>


        <!-- Main Forum (Thread List) View -->
        <div id="forumThreadsView" class="view">
             <div class="forum-content">
                 <div class="forum-section thread-list-view">
                     <div class="section-header">Forum Threads</div>
                     <ul class="thread-list" id="threadList">
                         <!-- Thread items will be loaded here by JavaScript -->
                          <p style="padding: 15px;">Loading threads...</p> <!-- Initial loading message -->
                     </ul>
                 </div>

                 <div class="create-thread-form">
                     <h3>Create New Thread</h3>
                     <input type="text" id="newThreadTitle" placeholder="Thread Title">
                     <button id="createThreadButton">Create Thread</button>
                 </div>
             </div>
        </div>


        <!-- Thread Posts View -->
        <div id="threadPostsView" class="view">
             <div class="forum-content thread-posts-view">
                  <!-- Thread title and meta will go here -->
                  <h2 id="currentThreadTitle"></h2>

                  <div class="posts-list-area">
                       <div id="postsList">
                            <!-- Individual posts will be added here by JavaScript -->
                            <p style="padding: 15px;">Loading posts...</p> <!-- Initial loading message -->
                       </div>
                  </div>


                 <div class="posting-area">
                     <h3>Reply to Thread</h3>
                     <textarea id="postContent" placeholder="Write your reply here..."></textarea>
                     <div class="posting-actions">
                         <div class="file-upload">
                             <input type="file" id="fileInput" multiple>
                             <label for="fileInput">Attach Files</label>
                        </div>
                         <button id="submitPostButton">Post Reply</button>
                    </div>
                </div>
             </div>
        </div>

    </div>

    <!-- Add a footer section here to match macserialjunkie.com -->

    <script>
        // --- Configuration ---
        const CONFIG = {
            // Change this to your local machine's IP address when running the backend
            // You can find your IP address by running 'ifconfig' in terminal
            BACKEND_URL: 'http://127.0.0.1:5000', // Local development
            // BACKEND_URL: 'http://YOUR_IP_ADDRESS:5000', // For GitHub Pages to connect to your local machine
        };

        const loginView = document.getElementById('loginView');
        const signupView = document.getElementById('signupView');
        const forumThreadsView = document.getElementById('forumThreadsView'); // Renamed
        const threadPostsView = document.getElementById('threadPostsView'); // New view

        const showSignUpLink = document.getElementById('showSignUp');
        const showSignInLink = document.getElementById('showSignIn');

        const loginUsernameInput = document.getElementById('loginUsername');
        const loginPasswordInput = document.getElementById('loginPassword');
        const signInButton = document.getElementById('signInButton');

        const signupUsernameInput = document.getElementById('signupUsername');
        const signupPasswordInput = document.getElementById('signupPassword');
        const signUpButton = document.getElementById('signUpButton');

        const threadList = document.getElementById('threadList');
        const newThreadTitleInput = document.getElementById('newThreadTitle'); // New input
        const createThreadButton = document.getElementById('createThreadButton'); // New button

        const currentThreadTitleElement = document.getElementById('currentThreadTitle'); // New element
        const postsList = document.getElementById('postsList');
        const postContentTextarea = document.getElementById('postContent');
        const fileInput = document.getElementById('fileInput');
        const submitPostButton = document.getElementById('submitPostButton');

        const accountIcon = document.getElementById('accountIcon');
        const accountMenu = document.getElementById('accountMenu');
        const signOutLink = document.getElementById('signOutLink');
        const manageAccountLink = document.getElementById('manageAccountLink');

        const backButton = document.getElementById('backButton'); // New back button reference

        let currentThreadId = null; // To keep track of the currently viewed thread


        // --- View Switching ---
        function showView(viewId) {
            // Hide all views
            loginView.classList.remove('active');
            signupView.classList.remove('active');
            forumThreadsView.classList.remove('active');
            threadPostsView.classList.remove('active');

            // Hide account menu when switching views
            accountMenu.classList.remove('active');

            // Show the requested view and manage header elements
            if (viewId === 'login' || viewId === 'signup') {
                document.querySelector('.header .back-button').style.display = 'none'; // Hide back button
                accountIcon.style.display = 'none'; // Hide account icon
                if (viewId === 'login') loginView.classList.add('active');
                else signupView.classList.add('active');
            } else if (viewId === 'threads') {
                 document.querySelector('.header .back-button').style.display = 'none'; // Hide back button
                 accountIcon.style.display = 'block'; // Show account icon
                 forumThreadsView.classList.add('active');
                 loadThreads(); // Load threads when showing this view
            } else if (viewId === 'threadPosts') {
                 document.querySelector('.header .back-button').style.display = 'block'; // Show back button
                 accountIcon.style.display = 'block'; // Show account icon
                 threadPostsView.classList.add('active');
                 if (currentThreadId !== null) {
                      // Load posts for the current thread
                      loadPostsForThread(currentThreadId);
                 } else {
                      // Should not happen if navigation is correct, but handle gracefully
                      console.error("Attempted to show thread posts view without a currentThreadId");
                      showView('threads'); // Go back to threads view
                 }
            }
        }

        // Event listeners for switching views
        showSignUpLink.addEventListener('click', (e) => {
            e.preventDefault(); // Prevent default link behavior
            showView('signup');
        });

        showSignInLink.addEventListener('click', (e) => {
            e.preventDefault(); // Prevent default link behavior
            showView('login');
        });

        backButton.addEventListener('click', () => {
             currentThreadId = null; // Reset current thread
             showView('threads'); // Go back to the thread list
        });


        // --- Authentication ---
        signInButton.addEventListener('click', async () => {
            const username = loginUsernameInput.value.trim();
            const password = loginPasswordInput.value.trim();

            if (!username || !password) {
                alert("Please enter username and password.");
                return;
            }

            try {
                const response = await fetch(`${CONFIG.BACKEND_URL}/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, password }),
                });

                const data = await response.json();

                if (response.ok) {
                    alert(data.message);
                    // --- Real Authentication ---
                    // In a real application, store the authentication token/session info securely.
                    // Store username and admin status locally for UI purposes (less secure for permissions)
                     localStorage.setItem('loggedInUser', username);
                     localStorage.setItem('isAdmin', data.is_admin); // Assuming backend sends is_admin


                    showView('threads'); // Go to the thread list view
                    loginUsernameInput.value = ''; // Clear fields
                    loginPasswordInput.value = '';
                } else {
                    alert(`Sign In Failed: ${data.message}`);
                }
            } catch (error) {
                console.error('Error during sign in:', error);
                alert('An error occurred during sign in. Ensure backend is running and accessible.');
            }
        });

        signUpButton.addEventListener('click', async () => {
            const username = signupUsernameInput.value.trim();
            const password = signupPasswordInput.value.trim();

            if (!username || !password) {
                alert("Please enter username and password.");
                return;
            }

            try {
                const response = await fetch(`${CONFIG.BACKEND_URL}/signup`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, password }),
                });

                const data = await response.json();

                if (response.ok) {
                    alert(data.message);
                    // Redirect to login after successful signup
                    showView('login');
                     signupUsernameInput.value = ''; // Clear fields
                     signupPasswordInput.value = '';
                } else {
                    alert(`Sign Up Failed: ${data.message}`);
                }
            } catch (error) {
                console.error('Error during sign up:', error);
                alert('An error occurred during sign up. Ensure backend is running and accessible.');
            }
        });


        // --- Forum Threads ---
        async function loadThreads() {
             threadList.innerHTML = '<p style="padding: 15px;">Loading threads...</p>'; // Show loading message
              try {
                   const response = await fetch(`${CONFIG.BACKEND_URL}/threads`);
                   const threads = await response.json();

                   threadList.innerHTML = ''; // Clear current threads

                   if (threads.length > 0) {
                        threads.forEach(thread => {
                            const threadItem = document.createElement('li');
                            threadItem.classList.add('thread-item');
                            threadItem.dataset.threadId = thread.id; // Store thread ID

                            threadItem.innerHTML = `
                                 <div class="thread-info">
                                     <div class="thread-title">${thread.title}</div>
                                     <div class="thread-meta">by ${thread.author}, ${new Date(thread.created_at).toLocaleString()}</div>
                                 </div>
                                 <div class="thread-reply-count">${thread.reply_count} replies</div>
                            `;

                            threadItem.addEventListener('click', () => {
                                 currentThreadId = thread.id; // Set the current thread
                                 currentThreadTitleElement.textContent = thread.title; // Set thread title in posts view
                                showView('threadPosts'); // Switch to thread posts view
                            });

                            threadList.appendChild(threadItem);
                        });
                   } else {
                        threadList.innerHTML = '<p style="padding: 15px;">No threads yet. Create one!</p>';
                   }

              } catch (error) {
                   console.error('Error loading threads:', error);
                   threadList.innerHTML = '<p style="padding: 15px;">Error loading threads. Ensure backend is running and accessible and has a /threads endpoint.</p>';
              }
        }

        createThreadButton.addEventListener('click', async () => {
             const title = newThreadTitleInput.value.trim();

             if (!title) {
                  alert("Please enter a thread title.");
                  return;
             }

             // --- Authentication Check (Simplified) ---
             const authorUsername = localStorage.getItem('loggedInUser');
             if (!authorUsername) {
                  alert("You must be logged in to create a thread.");
                  showView('login');
                  return;
             }

             try {
                  const response = await fetch(`${CONFIG.BACKEND_URL}/threads`, {
                       method: 'POST',
                       headers: {
                           'Content-Type': 'application/json',
                       },
                       body: JSON.stringify({ title, author_username: authorUsername }), // Fixed: Changed author_username to match backend expectation
                  });

                  const data = await response.json();

                  if (response.ok) {
                       alert(data.message);
                       newThreadTitleInput.value = ''; // Clear input
                       loadThreads(); // Reload threads after creation
                  } else {
                       alert(`Thread creation failed: ${data.message}`);
                  }

             } catch (error) {
                  console.error('Error creating thread:', error);
                  alert('An error occurred while creating the thread. Ensure backend is running and accessible and has a /threads POST endpoint.');
             }
        });


         // --- Forum Posts for a Thread ---
         async function loadPostsForThread(threadId) {
             // Fetches posts for a specific thread from the backend and displays them.
              postsList.innerHTML = '<p style="padding: 15px;">Loading posts...</p>'; // Show loading message
              try {
                   const response = await fetch(`${CONFIG.BACKEND_URL}/threads/${threadId}/posts`);
                   const posts = await response.json();

                   postsList.innerHTML = ''; // Clear current posts

                   if (posts.length > 0) {
                        const loggedInUser = localStorage.getItem('loggedInUser');
                        const isAdmin = localStorage.getItem('isAdmin') === 'true'; // Get admin status

                        posts.forEach(post => {
                            const postElement = document.createElement('div');
                            postElement.classList.add('post-item');

                            let deleteButtonHtml = '';
                            // Show delete button if user is admin OR is the author of the post
                            if (isAdmin || (loggedInUser && loggedInUser === post.author)) {
                                 deleteButtonHtml = `<span class="post-delete-button" data-post-id="${post.id}">Delete</span>`;
                            }

                            let filesHtml = '';
                            if (post.files && post.files.length > 0) {
                                 filesHtml = '<div class="post-files">';
                                 post.files.forEach(file => {
                                      // IMPORTANT: Use actual file URL from backend if implemented
                                      filesHtml += `<a href="${file.url}" target="_blank">${file.filename}</a>`;
                                 });
                                 filesHtml += '</div>';
                            }
                            postElement.innerHTML = `
                                <div class="post-header">
                                    <div class="post-author">${post.author}</div>
                                    ${deleteButtonHtml} <!-- Add delete button here -->
                                </div>
                                <div class="post-content">${post.content}</div>
                                ${filesHtml}
                                <div class="post-meta">Posted at: ${new Date(post.created_at).toLocaleString()}</div>
                            `; // Format timestamp (using created_at from backend)

                             // Add event listener for the delete button if it exists
                             const deleteButton = postElement.querySelector('.post-delete-button');
                             if (deleteButton) {
                                  deleteButton.addEventListener('click', () => {
                                       handleDeletePost(post.id);
                                  });
                             }

                             postsList.appendChild(postElement);
                        });
                   } else {
                        postsList.innerHTML = '<p style="padding: 15px;">No posts in this thread yet. Be the first to reply!</p>';
                   }

              } catch (error) {
                   console.error('Error loading posts:', error);
                   postsList.innerHTML = '<p style="padding: 15px;">Error loading posts. Ensure backend is running and accessible and has a /threads/&lt;thread_id&gt;/posts endpoint.</p>';
              }
         }


        // --- Posting Reply to Thread ---
        submitPostButton.addEventListener('click', async () => {
            const content = postContentTextarea.value.trim();
            const files = fileInput.files;

            if (!content && files.length === 0) {
                alert("Please write something or attach a file to post.");
                return;
            }

             if (currentThreadId === null) {
                  alert("Error: No thread selected to post in.");
                  console.error("Attempted to post without a selected thread.");
                  return;
             }

            // --- Authentication Check (Simplified) ---
            const authorUsername = localStorage.getItem('loggedInUser'); // Get logged-in username
             if (!authorUsername) {
                  alert("You must be logged in to post.");
                  showView('login');
                  return;
             }


            const formData = new FormData();
            // Send data expected by the backend /threads/<thread_id>/posts POST endpoint
            formData.append('content', content);
            formData.append('author_username', authorUsername); // Send author username for backend lookup
            for (let i = 0; i < files.length; i++) {
                formData.append('files', files[i]); // Append each selected file
            }

            try {
                 // POST to the specific thread's posts endpoint
                 const response = await fetch(`${CONFIG.BACKEND_URL}/threads/${currentThreadId}/posts`, {
                     method: 'POST',
                     // No 'Content-Type' header is needed when sending FormData
                     body: formData,
                 });

                const data = await response.json();

                if (response.ok) {
                    alert(data.message);
                    postContentTextarea.value = ''; // Clear textarea
                    fileInput.value = ''; // Clear file input
                    loadPostsForThread(currentThreadId); // Reload posts for the current thread
                } else {
                    alert(`Posting Failed: ${data.message}`);
                }
            } catch (error) {
                console.error('Error during posting:', error);
                alert('An error occurred while posting. Ensure backend is running and accessible and the posting endpoint is correct.');
            }
        });

        // --- Post Deletion ---
        async function handleDeletePost(postId) {
             if (!confirm("Are you sure you want to delete this post?")) {
                  return; // User cancelled
             }

             const loggedInUser = localStorage.getItem('loggedInUser');
             const isAdmin = localStorage.getItem('isAdmin') === 'true';

             if (!loggedInUser) {
                  alert("You must be logged in to delete posts.");
                  showView('login');
                  return;
             }

             // Note: The authorization check (is admin or is author) MUST be done securely on the backend.
             // The frontend check here is only for UI purposes (showing/hiding the button).


             try {
                  // Send DELETE request to the backend post endpoint, include username/admin for backend check
                  const response = await fetch(`${CONFIG.BACKEND_URL}/posts/${postId}?username=${encodeURIComponent(loggedInUser)}&is_admin=${isAdmin}`, {
                      method: 'DELETE',
                       headers: {
                          // Include authorization header in a real app (e.g., Bearer token)
                          // For this example, we'll rely on the backend's simplified check via query params for now.
                       }
                  });

                  const data = await response.json();

                  if (response.ok) {
                      alert(data.message);
                      loadPostsForThread(currentThreadId); // Reload posts to reflect deletion
                  } else {
                       alert(`Delete Failed: ${data.message}`);
                  }

             } catch (error) {
                  console.error('Error during post deletion:', error);
                  alert('An error occurred while deleting the post. Ensure backend is running and accessible.');
             }
        }


        // --- Account Menu Functionality ---
        accountIcon.addEventListener('click', () => {
             accountMenu.classList.toggle('active'); // Toggle visibility
        });

        // Close menu if clicking outside (optional)
        document.addEventListener('click', (event) => {
             // Check if the click is outside the menu AND outside the account icon
             if (!accountMenu.contains(event.target) && event.target !== accountIcon) {
                  accountMenu.classList.remove('active');
             }
        });


        signOutLink.addEventListener('click', async (e) => {
             e.preventDefault();

             // --- Backend Required for Real Logout ---
             // Send a request to a backend logout endpoint to invalidate the session/token.
             // For this example, we'll just clear local storage and show simulated success.
             try {
                 const response = await fetch(`${CONFIG.BACKEND_URL}/logout`, {
                     method: 'POST', // Or DELETE, depending on backend
                     headers: {
                          // Include authorization header if needed for logout endpoint
                     }
                 });

                 // Even if backend logout fails (e.g., no session), client-side clear is important for UI
                 localStorage.removeItem('loggedInUser');
                 localStorage.removeItem('isAdmin'); // Clear admin status too
                 // localStorage.removeItem('authToken'); // Clear token if using token auth


                 if (response.ok) {
                      alert("Logged out successfully.");
                 } else {
                      // Handle backend specific logout errors if any
                       const data = await response.json();
                       alert(`Logout (backend) failed: ${data.message}. Client-side logout performed.`);
                 }

             } catch (error) {
                 console.error('Error during logout:', error);
                 alert('An error occurred during logout. Ensure backend is running and accessible. Client-side logout performed.');
             }


             // Navigate back to login view regardless of backend success for simulation
             showView('login');
        });

        manageAccountLink.addEventListener('click', (e) => {
             e.preventDefault();
             // --- Backend/Frontend Required for Real Account Management ---
             // Navigate to a dedicated page/section to manage user details.
             alert("Manage Account clicked. This feature requires backend and frontend implementation.");
             accountMenu.classList.remove('active'); // Hide menu
             // In a real app, you'd navigate to a different view/page here
        });


        // --- Initial State ---
        // Check if user is already "logged in" via localStorage
        const initialView = localStorage.getItem('loggedInUser') ? 'threads' : 'login';
        showView(initialView);

    </script>
</body>
</html>